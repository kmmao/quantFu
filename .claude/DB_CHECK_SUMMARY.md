# æ•°æ®åº“è¡¨å®Œæ•´æ€§æ£€æŸ¥åŠŸèƒ½è¯´æ˜

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

åœ¨ç¯å¢ƒæ£€æŸ¥è„šæœ¬ä¸­æ–°å¢äº† **Supabase æ•°æ®åº“è¡¨å®Œæ•´æ€§æ£€æŸ¥**ï¼Œç¡®ä¿æ‰€æœ‰æ ¸å¿ƒè¡¨åœ¨å¼€å‘å‰å·²æ­£ç¡®åˆ›å»ºã€‚

---

## âœ… æ£€æŸ¥å†…å®¹

### æ ¸å¿ƒè¡¨åˆ—è¡¨ï¼ˆ9ä¸ªï¼‰

| è¡¨å | ç”¨é€” | åˆ›å»ºäº |
|------|------|--------|
| `accounts` | è´¦æˆ·ç®¡ç† | 001_init_schema.sql |
| `contracts` | åˆçº¦æ˜ å°„ï¼ˆææ˜Ÿâ†”å¤©å‹¤ï¼‰ | 001_init_schema.sql |
| `trades` | æˆäº¤è®°å½•ï¼ˆææ˜Ÿæ¨é€ï¼‰ | 001_init_schema.sql |
| `positions` | æŒä»“æ˜ç»†ï¼ˆè®¡ç®—ï¼‰ | 001_init_schema.sql |
| `position_snapshots` | æŒä»“å¿«ç…§ï¼ˆå¯¹è´¦ï¼‰ | 001_init_schema.sql |
| `lock_configs` | é”ä»“é…ç½® | 001_init_schema.sql |
| `rollover_records` | æ¢æœˆè®°å½• | 001_init_schema.sql |
| `market_data` | è¡Œæƒ…ç¼“å­˜ | 001_init_schema.sql |
| `notifications` | ç³»ç»Ÿé€šçŸ¥ | 001_init_schema.sql |

---

## ğŸ” æ£€æŸ¥é€»è¾‘

### æ­¥éª¤ 1: æ£€æŸ¥å®¹å™¨

```bash
docker ps --format '{{.Names}}' | grep -q "quantfu_postgres"
```

- âœ… å®¹å™¨è¿è¡Œ â†’ ç»§ç»­æ£€æŸ¥è¡¨
- âš ï¸  å®¹å™¨æœªè¿è¡Œ â†’ è·³è¿‡è¡¨æ£€æŸ¥ï¼Œæç¤ºå¯åŠ¨

### æ­¥éª¤ 2: é€è¡¨æ£€æŸ¥

å¯¹æ¯ä¸ªè¡¨æ‰§è¡Œï¼š

```bash
docker exec quantfu_postgres psql -U postgres -d postgres -tAc \
  "SELECT EXISTS (
    SELECT FROM information_schema.tables
    WHERE table_schema = 'public'
    AND table_name = '$table'
  );"
```

è¿”å›å€¼ï¼š
- `t` (true) â†’ è¡¨å­˜åœ¨ âœ“
- `f` (false) â†’ è¡¨ç¼ºå¤± âœ—

---

## ğŸ“Š æ£€æŸ¥ç»“æœç¤ºä¾‹

### åœºæ™¯ 1ï¼šæ•°æ®åº“æœªåˆå§‹åŒ–

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  8. Supabase æ•°æ®åº“è¡¨
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  â³ æ£€æŸ¥ Docker å®¹å™¨è¿è¡ŒçŠ¶æ€... âœ“ é€šè¿‡
     â†’ PostgreSQL å®¹å™¨è¿è¡Œä¸­

  æ£€æŸ¥æ•°æ®åº“è¡¨å®Œæ•´æ€§:

    â€¢ accounts: âœ— ç¼ºå¤±
    â€¢ contracts: âœ— ç¼ºå¤±
    â€¢ trades: âœ— ç¼ºå¤±
    â€¢ positions: âœ— ç¼ºå¤±
    â€¢ position_snapshots: âœ— ç¼ºå¤±
    â€¢ lock_configs: âœ— ç¼ºå¤±
    â€¢ rollover_records: âœ— ç¼ºå¤±
    â€¢ market_data: âœ— ç¼ºå¤±
    â€¢ notifications: âœ— ç¼ºå¤±

âœ— ç¼ºå°‘ 9 ä¸ªè¡¨

  â†’ ä¿®å¤æ–¹æ³•:
    1. è¿è¡Œæ•°æ®åº“åˆå§‹åŒ–:
       make db-init

    2. æˆ–æ‰‹åŠ¨æ‰§è¡Œè¿ç§»:
       docker exec -i quantfu_postgres psql -U postgres -d postgres < database/migrations/001_init_schema.sql
```

### åœºæ™¯ 2ï¼šæ•°æ®åº“å·²åˆå§‹åŒ–

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  8. Supabase æ•°æ®åº“è¡¨
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  â³ æ£€æŸ¥ Docker å®¹å™¨è¿è¡ŒçŠ¶æ€... âœ“ é€šè¿‡
     â†’ PostgreSQL å®¹å™¨è¿è¡Œä¸­

  æ£€æŸ¥æ•°æ®åº“è¡¨å®Œæ•´æ€§:

    â€¢ accounts: âœ“ å­˜åœ¨
    â€¢ contracts: âœ“ å­˜åœ¨
    â€¢ trades: âœ“ å­˜åœ¨
    â€¢ positions: âœ“ å­˜åœ¨
    â€¢ position_snapshots: âœ“ å­˜åœ¨
    â€¢ lock_configs: âœ“ å­˜åœ¨
    â€¢ rollover_records: âœ“ å­˜åœ¨
    â€¢ market_data: âœ“ å­˜åœ¨
    â€¢ notifications: âœ“ å­˜åœ¨

  âœ“ æ‰€æœ‰ 9 ä¸ªæ ¸å¿ƒè¡¨å·²åˆ›å»º
```

### åœºæ™¯ 3ï¼šå®¹å™¨æœªè¿è¡Œ

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  8. Supabase æ•°æ®åº“è¡¨
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  â³ æ£€æŸ¥ Docker å®¹å™¨è¿è¡ŒçŠ¶æ€... âš  è­¦å‘Š
     â†’ PostgreSQL å®¹å™¨æœªè¿è¡Œ
     â†’ å¯åŠ¨æ•°æ®åº“: make start
     â†’ æ•°æ®åº“å¯åŠ¨åå†è¿è¡Œæ­¤æ£€æŸ¥
```

---

## ğŸ› ï¸ ä¿®å¤æ–¹æ³•

### æ–¹æ³• 1ï¼šä½¿ç”¨ Makefileï¼ˆæ¨èï¼‰

```bash
# ä»…åˆå§‹åŒ–è¡¨ç»“æ„
make db-init

# åˆå§‹åŒ–è¡¨ç»“æ„ + å¯¼å…¥ç§å­æ•°æ®
make db-init && make db-seed

# å®Œå…¨é‡ç½®æ•°æ®åº“ï¼ˆå±é™©ï¼ï¼‰
make db-reset
```

### æ–¹æ³• 2ï¼šæ‰‹åŠ¨æ‰§è¡Œè¿ç§»

```bash
# æ‰§è¡Œä¸»è¿ç§»æ–‡ä»¶
docker exec -i quantfu_postgres psql -U postgres -d postgres \
  < database/migrations/001_init_schema.sql

# æ‰§è¡Œå…¶ä»–è¿ç§»ï¼ˆå¦‚éœ€è¦ï¼‰
docker exec -i quantfu_postgres psql -U postgres -d postgres \
  < database/migrations/003_lock_trigger.sql

docker exec -i quantfu_postgres psql -U postgres -d postgres \
  < database/migrations/004_contract_management.sql
```

### æ–¹æ³• 3ï¼šè¿›å…¥æ•°æ®åº“æ‰‹åŠ¨æ“ä½œ

```bash
# è¿›å…¥æ•°æ®åº“ Shell
make db-shell
# æˆ–
docker exec -it quantfu_postgres psql -U postgres -d postgres

# æŸ¥çœ‹æ‰€æœ‰è¡¨
\dt

# æŸ¥çœ‹è¡¨ç»“æ„
\d accounts

# é€€å‡º
\q
```

---

## ğŸ“‹ å®Œæ•´å·¥ä½œæµ

### é¦–æ¬¡è®¾ç½®é¡¹ç›®

```bash
# 1. æ£€æŸ¥ç¯å¢ƒ
make check
# å‘ç°ï¼šâœ— ç¼ºå°‘ 9 ä¸ªè¡¨

# 2. å¯åŠ¨æ•°æ®åº“ï¼ˆå¦‚æœæœªè¿è¡Œï¼‰
make start

# 3. åˆå§‹åŒ–æ•°æ®åº“
make db-init

# 4. å†æ¬¡æ£€æŸ¥
make check
# ç»“æœï¼šâœ“ æ‰€æœ‰ 9 ä¸ªæ ¸å¿ƒè¡¨å·²åˆ›å»º

# 5. å¯åŠ¨å¼€å‘ç¯å¢ƒ
make dev-full
```

### æ—¥å¸¸å¼€å‘

```bash
# æ¯å¤©å¼€å§‹å‰æ£€æŸ¥ä¸€æ¬¡
make check

# å¦‚æœå‘ç°è¡¨ç¼ºå¤±ï¼Œé‡æ–°åˆå§‹åŒ–
make db-init
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: å®¹å™¨è¿è¡Œä½†æ£€æŸ¥å¤±è´¥

**ç—‡çŠ¶**:
```
Docker å®¹å™¨è¿è¡ŒçŠ¶æ€... âœ“ é€šè¿‡
ä½†æ‰€æœ‰è¡¨æ˜¾ç¤º âœ— ç¼ºå¤±
```

**åŸå› **: å®¹å™¨è¿è¡Œä½†æ•°æ®åº“æœªåˆå§‹åŒ–

**è§£å†³**:
```bash
make db-init
```

### é—®é¢˜ 2: æƒé™é”™è¯¯

**ç—‡çŠ¶**:
```
ERROR: permission denied for table ...
```

**è§£å†³**:
```bash
# æ£€æŸ¥ .env æ–‡ä»¶ä¸­çš„å¯†ç é…ç½®
cat .env | grep POSTGRES_PASSWORD

# é‡å¯æ•°æ®åº“
make restart

# é‡æ–°åˆå§‹åŒ–
make db-reset
```

### é—®é¢˜ 3: è¡¨å·²å­˜åœ¨é”™è¯¯

**ç—‡çŠ¶**:
```
ERROR: relation "accounts" already exists
```

**è§£å†³**:
è¿™ä¸æ˜¯é”™è¯¯ï¼å¦‚æœè¡¨å·²å­˜åœ¨ï¼Œ`CREATE TABLE IF NOT EXISTS` ä¼šå¿½ç•¥ã€‚
æˆ–è€…ä½¿ç”¨ `make db-reset` å®Œå…¨é‡å»ºã€‚

---

## ğŸ“ˆ ç»Ÿè®¡æ•°æ®

### æ£€æŸ¥é¡¹æ•°é‡å˜åŒ–

**æ–°å¢å‰**:
- 7 ä¸ªæ£€æŸ¥ç±»åˆ«
- 28 ä¸ªæ£€æŸ¥é¡¹

**æ–°å¢å**:
- 8 ä¸ªæ£€æŸ¥ç±»åˆ«ï¼ˆ+1ï¼‰
- 37 ä¸ªæ£€æŸ¥é¡¹ï¼ˆ+9ï¼Œæ¯ä¸ªè¡¨ 1 é¡¹ï¼‰

### å…¸å‹æ£€æŸ¥ç»“æœ

**å®Œæ•´ç¯å¢ƒ**:
```
âœ“ é€šè¿‡: 37
âš  è­¦å‘Š: 11 (ç«¯å£å ç”¨ã€Dockeré•œåƒç­‰)
âœ— å¤±è´¥: 0
```

**æ•°æ®åº“æœªåˆå§‹åŒ–**:
```
âœ“ é€šè¿‡: 28
âš  è­¦å‘Š: 11
âœ— å¤±è´¥: 9 (9ä¸ªè¡¨ç¼ºå¤±)
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. å®šæœŸæ£€æŸ¥

```bash
# æ¯å¤©ç¬¬ä¸€æ¬¡å¯åŠ¨é¡¹ç›®æ—¶
make check

# æˆ–è®¾ç½® shell åˆ«å
alias check-quantfu="cd ~/path/to/quantfu && make check"
```

### 2. CI/CD é›†æˆ

```yaml
# .github/workflows/ci.yml
- name: Check database tables
  run: |
    make start
    sleep 10  # ç­‰å¾…æ•°æ®åº“å¯åŠ¨
    make db-init
    make check
```

### 3. å›¢é˜Ÿåä½œ

```bash
# æ‹‰å–ä»£ç å
git pull
make check  # æ£€æŸ¥ç¯å¢ƒ

# å¦‚æœæœ‰æ–°çš„è¿ç§»æ–‡ä»¶
make db-init  # é‡æ–°åˆå§‹åŒ–

# å‘ç°é—®é¢˜
make db-reset  # å®Œå…¨é‡ç½®ï¼ˆå°å¿ƒä½¿ç”¨ï¼‰
```

---

## ğŸ”— ç›¸å…³èµ„æº

- [ç¯å¢ƒæ£€æŸ¥è„šæœ¬](../check-env.sh)
- [æ•°æ®åº“è¿ç§»æ–‡ä»¶](../database/migrations/)
- [Makefile æ•°æ®åº“å‘½ä»¤](../Makefile)
- [ç»éªŒæ•™è®­æ–‡æ¡£](LESSONS_LEARNED.md)

---

## ğŸ“Œ æ³¨æ„äº‹é¡¹

### âš ï¸  é‡è¦æé†’

1. **ç”Ÿäº§ç¯å¢ƒ**: ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œ `make db-reset`
2. **æ•°æ®å¤‡ä»½**: é‡ç½®å‰å…ˆå¤‡ä»½ï¼š`make db-backup`
3. **å®¹å™¨çŠ¶æ€**: ç¡®ä¿å®¹å™¨è¿è¡Œå†æ£€æŸ¥è¡¨
4. **æƒé™é—®é¢˜**: ä½¿ç”¨ .env ä¸­é…ç½®çš„å¯†ç 

### âœ… å®‰å…¨æ“ä½œ

- `make check` - åªè¯»æ£€æŸ¥ï¼Œå®‰å…¨
- `make db-init` - ä»…åˆ›å»ºè¡¨ï¼Œä¸åˆ é™¤æ•°æ®
- `make db-seed` - å¯¼å…¥ç§å­æ•°æ®ï¼Œå®‰å…¨
- `make db-shell` - è¿›å…¥ Shellï¼Œå°å¿ƒæ“ä½œ

### âŒ å±é™©æ“ä½œ

- `make db-reset` - åˆ é™¤æ‰€æœ‰æ•°æ®ï¼
- `make clean` - åˆ é™¤ Docker å·ï¼
- æ‰‹åŠ¨ `DROP TABLE` - æ°¸ä¹…åˆ é™¤ï¼

---

**æœ€åæ›´æ–°**: 2025-12-23
**ç»´æŠ¤è€…**: allen + AI
**ç‰ˆæœ¬**: 1.0.0
