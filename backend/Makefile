# QuantFu åç«¯ - Makefile
#
# å¿«é€Ÿå¼€å§‹:
#   make dev        - å¯åŠ¨å¼€å‘æœåŠ¡å™¨
#   make test       - è¿è¡Œæµ‹è¯•
#
# æ³¨æ„: æœ¬é¡¹ç›®ä½¿ç”¨ uv åŒ…ç®¡ç†å™¨ (å¦‚æœå¯ç”¨)

.PHONY: help dev test lint format type-check clean
.PHONY: install update

# æ£€æµ‹ uv æ˜¯å¦å¯ç”¨
UV_AVAILABLE := $(shell command -v uv 2> /dev/null)

help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "  QuantFu åç«¯ - å¯ç”¨å‘½ä»¤"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@if [ -n "$(UV_AVAILABLE)" ]; then \
		echo "ğŸ“¦ åŒ…ç®¡ç†å™¨: uv (é«˜é€Ÿ)"; \
	else \
		echo "ğŸ“¦ åŒ…ç®¡ç†å™¨: pip (æ ‡å‡†)"; \
		echo "ğŸ’¡ å®‰è£… uv ä»¥æå‡é€Ÿåº¦: curl -LsSf https://astral.sh/uv/install.sh | sh"; \
	fi
	@echo ""
	@echo "ğŸ’¡ æç¤º: ä¸»é¡¹ç›®å‘½ä»¤è¯·è¿”å›æ ¹ç›®å½•è¿è¡Œ 'make help'"
	@echo ""

# ==========================================
# å¼€å‘å‘½ä»¤
# ==========================================

dev: ## å¯åŠ¨å¼€å‘æœåŠ¡å™¨ (http://localhost:8888)
	@echo "ğŸ”§ å¯åŠ¨åç«¯å¼€å‘æœåŠ¡å™¨..."
ifdef UV_AVAILABLE
	@uv run uvicorn main:app --reload --port 8888
else
	@source .venv/bin/activate && uvicorn main:app --reload --port 8888
endif

dev-bg: ## åå°å¯åŠ¨å¼€å‘æœåŠ¡å™¨
	@echo "ğŸ”§ åå°å¯åŠ¨åç«¯å¼€å‘æœåŠ¡å™¨..."
ifdef UV_AVAILABLE
	@uv run uvicorn main:app --reload --port 8888 > backend.log 2>&1 & echo $$! > /tmp/quantfu-backend.pid
else
	@source .venv/bin/activate && uvicorn main:app --reload --port 8888 > backend.log 2>&1 & echo $$! > /tmp/quantfu-backend.pid
endif
	@echo "âœ… åç«¯æœåŠ¡å·²åœ¨åå°å¯åŠ¨"
	@echo "ğŸ“‹ æŸ¥çœ‹æ—¥å¿—: make logs"

stop: ## åœæ­¢åå°æœåŠ¡
	@if [ -f /tmp/quantfu-backend.pid ]; then \
		echo "ğŸ›‘ åœæ­¢åç«¯æœåŠ¡..."; \
		kill `cat /tmp/quantfu-backend.pid` 2>/dev/null || true; \
		rm /tmp/quantfu-backend.pid; \
		echo "âœ… åç«¯æœåŠ¡å·²åœæ­¢"; \
	else \
		echo "âŒ æœªæ‰¾åˆ°è¿è¡Œä¸­çš„åå°æœåŠ¡"; \
	fi

# ==========================================
# æµ‹è¯•å‘½ä»¤
# ==========================================

test: ## è¿è¡Œæµ‹è¯•
	@echo "ğŸ§ª è¿è¡Œåç«¯æµ‹è¯•..."
ifdef UV_AVAILABLE
	@uv run pytest
else
	@source .venv/bin/activate && pytest
endif

test-verbose: ## è¿è¡Œæµ‹è¯• (è¯¦ç»†æ¨¡å¼)
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯• (è¯¦ç»†æ¨¡å¼)..."
ifdef UV_AVAILABLE
	@uv run pytest -v
else
	@source .venv/bin/activate && pytest -v
endif

test-coverage: ## è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡..."
ifdef UV_AVAILABLE
	@uv run pytest --cov=. --cov-report=html --cov-report=term
else
	@source .venv/bin/activate && pytest --cov=. --cov-report=html --cov-report=term
endif
	@echo "ğŸ“Š è¦†ç›–ç‡æŠ¥å‘Š: htmlcov/index.html"

test-watch: ## è¿è¡Œæµ‹è¯• (ç›‘å¬æ¨¡å¼)
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯• (ç›‘å¬æ¨¡å¼)..."
ifdef UV_AVAILABLE
	@uv run pytest-watch
else
	@source .venv/bin/activate && pytest-watch
endif

# ==========================================
# ä»£ç è´¨é‡
# ==========================================

lint: ## ä»£ç æ£€æŸ¥ (ruff)
	@echo "ğŸ” æ£€æŸ¥ä»£ç è´¨é‡..."
ifdef UV_AVAILABLE
	@uv run ruff check .
else
	@source .venv/bin/activate && ruff check .
endif

lint-fix: ## è‡ªåŠ¨ä¿®å¤ä»£ç é—®é¢˜
	@echo "ğŸ”§ è‡ªåŠ¨ä¿®å¤ä»£ç é—®é¢˜..."
ifdef UV_AVAILABLE
	@uv run ruff check --fix .
else
	@source .venv/bin/activate && ruff check --fix .
endif

format: ## æ ¼å¼åŒ–ä»£ç  (ruff format)
	@echo "âœ¨ æ ¼å¼åŒ–ä»£ç ..."
ifdef UV_AVAILABLE
	@uv run ruff format .
else
	@source .venv/bin/activate && ruff format .
endif

type-check: ## ç±»å‹æ£€æŸ¥ (mypy)
	@echo "ğŸ” ç±»å‹æ£€æŸ¥..."
ifdef UV_AVAILABLE
	@uv run mypy .
else
	@source .venv/bin/activate && mypy .
endif

# ==========================================
# ä¾èµ–ç®¡ç†
# ==========================================

install: ## å®‰è£…ä¾èµ–
	@echo "ğŸ“¦ å®‰è£…åç«¯ä¾èµ–..."
ifdef UV_AVAILABLE
	@echo "  ä½¿ç”¨ uv å®‰è£…..."
	@uv venv
	@uv sync
else
	@echo "  ä½¿ç”¨ pip å®‰è£…..."
	@python3 -m venv .venv
	@source .venv/bin/activate && pip install -r requirements.txt
endif
	@echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

update: ## æ›´æ–°ä¾èµ–
	@echo "ğŸ“¦ æ›´æ–°ä¾èµ–..."
ifdef UV_AVAILABLE
	@uv sync --upgrade
else
	@source .venv/bin/activate && pip install --upgrade -r requirements.txt
endif
	@echo "âœ… ä¾èµ–å·²æ›´æ–°"

add: ## æ·»åŠ æ–°ä¾èµ– (ä½¿ç”¨: make add PKG=package-name)
	@if [ -z "$(PKG)" ]; then \
		echo "âŒ è¯·æŒ‡å®šåŒ…åç§°"; \
		echo "   ç¤ºä¾‹: make add PKG=requests"; \
		exit 1; \
	fi
	@echo "ğŸ“¦ æ·»åŠ ä¾èµ–: $(PKG)..."
ifdef UV_AVAILABLE
	@uv add $(PKG)
else
	@source .venv/bin/activate && pip install $(PKG) && pip freeze > requirements.txt
endif
	@echo "âœ… ä¾èµ–å·²æ·»åŠ "

check-deps: ## æ£€æŸ¥ä¾èµ–å®Œæ•´æ€§
	@echo "ğŸ” æ£€æŸ¥ä¾èµ–..."
ifdef UV_AVAILABLE
	@uv pip list
else
	@source .venv/bin/activate && pip list
endif

# ==========================================
# æ¸…ç†å‘½ä»¤
# ==========================================

clean: ## æ¸…ç†ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶
	@echo "ğŸ§¹ æ¸…ç†ç¼“å­˜..."
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name ".ruff_cache" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name ".mypy_cache" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name "htmlcov" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@find . -type f -name ".coverage" -delete 2>/dev/null || true
	@rm -f backend.log 2>/dev/null || true
	@echo "âœ… æ¸…ç†å®Œæˆ"

clean-all: ## æ¸…ç†æ‰€æœ‰æ–‡ä»¶ (åŒ…æ‹¬è™šæ‹Ÿç¯å¢ƒ)
	@echo "âš ï¸  è­¦å‘Š: è¿™å°†åˆ é™¤è™šæ‹Ÿç¯å¢ƒ!"
	@read -p "ç¡®è®¤åˆ é™¤? (y/N): " confirm && [ "$$confirm" = "y" ] || exit 1
	@$(MAKE) clean
	@rm -rf .venv uv.lock
	@echo "âœ… å·²æ¸…ç†æ‰€æœ‰æ–‡ä»¶"
	@echo "ğŸ’¡ é‡æ–°å®‰è£…ä¾èµ–: make install"

# ==========================================
# å¼€å‘å·¥å…·
# ==========================================

shell: ## è¿›å…¥ Python REPL
	@echo "ğŸ è¿›å…¥ Python REPL..."
ifdef UV_AVAILABLE
	@uv run python
else
	@source .venv/bin/activate && python
endif

logs: ## æŸ¥çœ‹å¼€å‘æ—¥å¿—
	@if [ -f "backend.log" ]; then \
		echo "ğŸ” æŸ¥çœ‹åç«¯æ—¥å¿— (Ctrl+C é€€å‡º)..."; \
		tail -f backend.log; \
	else \
		echo "âŒ æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: backend.log"; \
		echo "ğŸ’¡ è¯·å…ˆå¯åŠ¨åå°æœåŠ¡: make dev-bg"; \
	fi

# ==========================================
# æ•°æ®åº“å·¥å…·
# ==========================================

db-migrate: ## è¿è¡Œæ•°æ®åº“è¿ç§» (ä½¿ç”¨ Alembic)
	@echo "ğŸ“‹ è¿è¡Œæ•°æ®åº“è¿ç§»..."
ifdef UV_AVAILABLE
	@uv run alembic upgrade head
else
	@source .venv/bin/activate && alembic upgrade head
endif
	@echo "âœ… è¿ç§»å®Œæˆ"

db-revision: ## åˆ›å»ºæ–°çš„è¿ç§»æ–‡ä»¶ (ä½¿ç”¨: make db-revision MSG="message")
	@if [ -z "$(MSG)" ]; then \
		echo "âŒ è¯·æä¾›è¿ç§»è¯´æ˜"; \
		echo "   ç¤ºä¾‹: make db-revision MSG=\"add user table\""; \
		exit 1; \
	fi
	@echo "ğŸ“ åˆ›å»ºè¿ç§»æ–‡ä»¶..."
ifdef UV_AVAILABLE
	@uv run alembic revision --autogenerate -m "$(MSG)"
else
	@source .venv/bin/activate && alembic revision --autogenerate -m "$(MSG)"
endif
	@echo "âœ… è¿ç§»æ–‡ä»¶å·²åˆ›å»º"
